<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >

<sqlMap namespace="CTMW02">
	<typeAlias alias="hashMap" type="java.util.HashMap"/>
	<typeAlias alias="string" type="java.lang.String"/>
	<typeAlias alias="object" type="java.lang.Object"/>
    <typeAlias alias="integer" type="java.lang.Integer"/>
    
<!-- 표준시간 조회 -->
<select id="CTMW02DAO.standardTimeList" parameterClass="hashMap" resultClass="hashMap">
<![CDATA[
SELECT   STD_TIME_SN
		,STD_TIME_NM 
		,STD_TIME_STDR 
FROM 
		CM_STD_TIME

]]>	
</select> 


<select id="CTMW02DAO.selectCTMW0201" parameterClass="hashMap" resultClass="hashMap">
<![CDATA[
SELECT	 M.LAND1 
		,'' 				AS SITE_ID
		,'' 				AS SITE_NAME
		,M.USER_ID
		,M.GOAL_NO
		,M.VISIT_SN 		AS ENTERED
		,'' 				AS VERIFIED
		,M.INSTT_FORM_SN
		
		,(SELECT COUNT(SUBJECT_NO) 
			FROM EDC_CF_SUBJECT 
			WHERE INSTT_FORM_SN = M.INSTT_FORM_SN 
			  AND FREEZING_STTUS_CODE = '03') AS FROZEN
			  
		,(SELECT COUNT(FQ.QUERY_MASTR_SN) 
			FROM EDC_CF_QUERY EQ
			,CT_QUERY_MASTR FQ 
			WHERE EQ.QUERY_MASTR_SN = FQ.QUERY_MASTR_SN 
			  AND QUERY_STTUS_CODE = '01') AS OPEN_QUERY
			  
		,(SELECT COUNT(FQ.QUERY_MASTR_SN) 
			FROM EDC_CF_QUERY EQ
			,CT_QUERY_MASTR FQ 
			WHERE EQ.QUERY_MASTR_SN = FQ.QUERY_MASTR_SN 		
			  AND QUERY_STTUS_CODE = '04') AS CLOSE_QUERY
		,M.TASK_SN
		,M.INSTT_CODE
		,(SELECT USER_NM FROM CM_USER UR WHERE UR.USER_ID = M.USER_ID) USER_NM		
FROM(
	SELECT  	
	 BC.LAND1 
	,CI.INSTT_FORM_SN
	,UT.TASK_SN 
	,UT.USER_ID
	,MA.GOAL_NO
	,RS.INSTT_CODE
	,COUNT(VISIT_SN) VISIT_SN
	FROM
	CM_USERTASK UT
	,CTMS_CO_CNTRCT_MANAGE MA
	,CM_RSRCHUSER RS
	,EDC_CR_INSTT_FORM CI
	,EDC_CF_VISIT VI
	,CM_INSTT ST
	,SAP_BCNC_INFO BC
	WHERE 1=1 
	AND UT.TASK_SN = MA.TASK_SN
	AND UT.USER_ID = MA.USER_ID
	AND UT.USER_ID = RS.USER_ID
	AND UT.TASK_SN = CI.TASK_SN
	AND RS.INSTT_CODE = CI.INSTT_CODE
	AND CI.INSTT_FORM_SN = VI.INSTT_FORM_SN
	AND ST.KUNNR = BC.KUNNR
	AND CI.INSTT_CODE = ST.INSTT_CODE
	AND UT.TASK_SN = #TASK_SN#
	GROUP BY UT.TASK_SN , UT.USER_ID, MA.GOAL_NO, RS.INSTT_CODE, BC.LAND1, CI.INSTT_FORM_SN
) M

]]>
</select>

<select id="CTMW02DAO.selectCTMW0202" parameterClass="hashMap" resultClass="hashMap">
<![CDATA[
SELECT	 DISTINCT
    M.LAND1 
		,'' 				AS SITE_ID
		,'' 				AS SITE_NAME
		,M.USER_ID
		,M.VISIT_SN		
		,M.GOAL_NO	
		,(SELECT COUNT(VISIT_SN) FROM EDC_CF_VISIT WHERE VISIT_SN = M.VISIT_SN) AS ENTERED	
		,'' 				AS VERIFIED
		,M.INSTT_FORM_SN		
		,'' AS FROZEN
			  
		,(SELECT COUNT(FQ.QUERY_MASTR_SN) 
			FROM EDC_CF_QUERY EQ
			,CT_QUERY_MASTR FQ 
			WHERE EQ.QUERY_MASTR_SN = FQ.QUERY_MASTR_SN 
			  AND QUERY_STTUS_CODE = '01' AND EQ.VISIT_SN = M.VISIT_SN AND EQ.VISIT_SN = M.VISIT_SN) AS OPEN_QUERY
			  
		,(SELECT COUNT(FQ.QUERY_MASTR_SN) 
			FROM EDC_CF_QUERY EQ
			,CT_QUERY_MASTR FQ 
			WHERE EQ.QUERY_MASTR_SN = FQ.QUERY_MASTR_SN 		
			  AND QUERY_STTUS_CODE = '04'  AND EQ.VISIT_SN = M.VISIT_SN AND EQ.VISIT_SN = M.VISIT_SN) AS CLOSE_QUERY
		,M.TASK_SN
		,M.INSTT_CODE
		,(SELECT USER_NM FROM CM_USER UR WHERE UR.USER_ID = M.USER_ID) USER_NM
    ,M.VISIT_LBL
FROM(
	SELECT
	BC.LAND1 
	,CI.INSTT_FORM_SN
	,UT.TASK_SN 
	,UT.USER_ID
	,MA.GOAL_NO
	,RS.INSTT_CODE
	
	,VI.VISIT_SN
  ,VS.VISIT_LBL
	FROM
	CM_USERTASK UT
	,CTMS_CO_CNTRCT_MANAGE MA
	,CM_RSRCHUSER RS
	,EDC_CR_INSTT_FORM CI
	,EDC_CF_VISIT VI
	,CM_INSTT ST
	,SAP_BCNC_INFO BC	
  ,EDC_CR_VISIT_SCHDUL VS  
	WHERE 1=1 
	AND UT.TASK_SN = MA.TASK_SN
	AND UT.USER_ID = MA.USER_ID
	AND UT.USER_ID = RS.USER_ID
	AND UT.TASK_SN = CI.TASK_SN
	AND RS.INSTT_CODE = CI.INSTT_CODE
	AND CI.INSTT_FORM_SN = VI.INSTT_FORM_SN
	AND ST.KUNNR = BC.KUNNR
	AND CI.INSTT_CODE = ST.INSTT_CODE
  AND VI.VISIT_SN = VS.VISIT_SN(+)
	AND UT.TASK_SN = #TASK_SN#
	GROUP BY UT.TASK_SN , UT.USER_ID, MA.GOAL_NO, RS.INSTT_CODE, BC.LAND1, CI.INSTT_FORM_SN, VI.VISIT_SN, VI.SUBJECT_NO, VS.VISIT_LBL
	
) M
ORDER BY M.VISIT_SN ASC, M.INSTT_CODE ASC
]]>
</select>


<select id="CTMW02DAO.selectCTMW0203" parameterClass="hashMap" resultClass="hashMap">
<![CDATA[
SELECT	 M.LAND1
		,'' AS SITE_ID
		,'' AS SITE_NAME
		,M.SUBJECT_NO
		,M.SUBJECT_STTUS_CODE
		,(SELECT MAX(X.VISIT_SN) 
			FROM EDC_CF_VISIT X
		        ,EDC_CR_VISIT_SCHDUL Y 
		  WHERE X.SUBJECT_NO = M.SUBJECT_NO 
		    AND X.VISIT_SN = Y.VISIT_SN) VISIT
		    
		,(SELECT MAX(VISIT_LBL) 
			FROM EDC_CF_VISIT X
		        ,EDC_CR_VISIT_SCHDUL Y 
		    WHERE X.SUBJECT_NO = M.SUBJECT_NO 
		      AND X.VISIT_SN = Y.VISIT_SN 
		      AND X.VISIT_SN=((SELECT MAX(X.VISIT_SN) 
		      					FROM EDC_CF_VISIT X
		      				   ,EDC_CR_VISIT_SCHDUL Y 
		      				   WHERE X.SUBJECT_NO = M.SUBJECT_NO 
		      				     AND X.VISIT_SN = Y.VISIT_SN))) VISIT_LBL
		,M.CRF_VER
		,'' AS CRF_EFFECTIVE
		,M.EDC_VER
		,'' AS EDC_EFFECTIVE
FROM(
		SELECT	DISTINCT
				CF.SUBJECT_NO
				,SUBJECT_STTUS_CODE 
				,MAX(VS.EDC_VER) AS EDC_VER
				,MAX(CO.CRF_VER) AS CRF_VER
				,LAND1
		FROM 
				EDC_CF_SUBJECT CF
				,EDC_CF_VISIT CV
				,EDC_CR_VISIT_SCHDUL VS
				,EDC_CR_FORM CO
				,EDC_CR_INSTT_FORM CI
				,CM_INSTT IT
				,SAP_BCNC_INFO BI
		WHERE	 CF.SUBJECT_NO = CV.SUBJECT_NO(+)
		  AND 	 CV.VISIT_SN = VS.VISIT_SN(+)
		  AND 	 VS.EDC_VER = CO.EDC_VER(+)
		  AND 	 CI.INSTT_FORM_SN = CF.INSTT_FORM_SN
		  AND 	 CI.INSTT_CODE = IT.INSTT_CODE
		  AND 	 IT.KUNNR = BI.KUNNR(+)
		  AND    CI.TASK_SN = #TASK_SN#
		  GROUP BY CF.SUBJECT_NO, SUBJECT_STTUS_CODE ,LAND1
	) M
ORDER BY SUBJECT_NO ASC
]]>
</select>


<select id="CTMW02DAO.selectCTMW0205" parameterClass="hashMap" resultClass="hashMap">
<![CDATA[
SELECT
M.DEPT_LAND
,M.STD_TIME_SN
,'' AS SITE_ID
,'' AS SITE_NAME
,M.USER_ID
,M.USER_NM
,M.LOGIN_DE
,M.LOGOUT_DE
,M.DSCNTC_DE
,M.DSCNTC_AT
FROM(
SELECT	DECODE(USER_SE_CODE, '01', 'KR'				
			,'02',
				(SELECT X.LAND1 
  					FROM CM_INSTT Y, SAP_BCNC_INFO X
  					WHERE Y.KUNNR = X.KUNNR
 					AND Y.INSTT_CODE = (SELECT X.INSTT_CODE FROM CM_RSRCHUSER X WHERE X.USER_ID = US.USER_ID
 					UNION 
 					SELECT X.INSTT_CODE FROM CM_BCNCUSER X WHERE X.USER_ID = US.USER_ID))
			) DEPT_LAND
        ,US.STD_TIME_SN
	    ,US.USER_ID
	    ,US.USER_NM
        ,TO_CHAR(UT.FRST_CREDE, 'YYYYMMDDHH24MISS') AS FRST_CREDE
        ,TO_CHAR((SELECT MAX(CONECT_DT) FROM  CM_SYS_CONECT WHERE CONECT_SE = '01' AND USER_ID = US.USER_ID), 'YYYYMMDDHH24MISS') AS  LOGIN_DE
        ,TO_CHAR((SELECT MAX(CONECT_DT) FROM  CM_SYS_CONECT WHERE CONECT_SE = '04' AND USER_ID = US.USER_ID), 'YYYYMMDDHH24MISS') AS LOGOUT_DE
        ,RO.ROLE_ID
        ,TO_CHAR(UT.DSCNTC_DE, 'YYYYMMDDHH24MISS') AS DSCNTC_DE
		,UT.DSCNTC_AT
FROM     CM_USERTASK UT
		,CM_USER US
		,CM_TASK_USER_ROLE RO
WHERE    UT.USER_ID = US.USER_ID
  AND    UT.USER_ID = RO.USER_ID
  AND    UT.TASK_SN = RO.TASK_SN
  AND    UT.TASK_SN = #TASK_SN#
)M
]]>
</select>

<select id="CTMW02DAO.selectCTMW0206" parameterClass="hashMap" resultClass="hashMap">
<![CDATA[
SELECT
M.DEPT_LAND
,'' AS SITE_ID
,'' AS SITE_NAME
,M.USER_ID
,M.USER_NM
,M.ROLE_ID
,M.DSCNTC_DE
,M.DSCNTC_AT
,M.ROLE_ID
FROM(
	SELECT	DECODE(USER_SE_CODE, '01', 'KR'				
				,'02',
					(SELECT X.LAND1 
	  					FROM CM_INSTT Y, SAP_BCNC_INFO X
	  					WHERE Y.KUNNR = X.KUNNR
	 					AND Y.INSTT_CODE = (SELECT X.INSTT_CODE FROM CM_RSRCHUSER X WHERE X.USER_ID = US.USER_ID
	 					UNION 
	 					SELECT X.INSTT_CODE FROM CM_BCNCUSER X WHERE X.USER_ID = US.USER_ID))
				) DEPT_LAND
	
			,US.USER_ID
			,US.USER_NM
			,RO.ROLE_ID      
			,TO_CHAR(UT.DSCNTC_DE, 'YYYYMMDDHH24MISS') AS DSCNTC_DE
			,UT.DSCNTC_AT		
	FROM     CM_USERTASK UT
			,CM_USER US
			,CM_TASK_USER_ROLE RO
	WHERE    UT.USER_ID = US.USER_ID 
	  AND    UT.USER_ID = RO.USER_ID
	  AND    UT.TASK_SN = RO.TASK_SN
	  AND    UT.TASK_SN = #TASK_SN#
)M
]]>
</select>




</sqlMap>